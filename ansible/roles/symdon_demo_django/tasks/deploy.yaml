- file:
    path: "{{ root_dir }}"
    state: directory

- file:
    path: "{{ systemd_dir }}"
    state: directory

- file:
    path: "{{ log_dir }}"
    state: directory

- file:
    path: "{{ env_dir }}"
    state: directory

- file:
    path: "{{ static_root }}"
    state: directory

- template:
    src: _env.env
    dest: "{{ root_dir }}/.env"
  changed_when: true
  notify: service demo-django restart

- template:
    src: systemd/_.service
    dest: "{{ systemd_dir }}/{{ service_name }}.service"

- file:
    src: "{{ systemd_dir }}/{{ service_name }}.service"
    dest: "/etc/systemd/system/{{ service_name }}.service"
    state: link

- file:
    src: "{{ log_dir }}"
    dest: "/var/log/{{ service_name }}"
    state: link
    
- git:
    repo: "{{ git_repo }}"
    dest: "{{ src_dir }}"
  changed_when: true
  notify: service demo-django restart

- command: "python3.7 -m venv {{ venv_dir }}"
  args:
    creates: "{{ root_dir }}"

- pip:
    requirements: "{{ pip_requirements }}"
    executable: "{{ venv_dir }}/bin/pip"

- template:
    src: sites-available/_upstream.conf
    dest: "/etc/nginx/sites-available/{{ domain }}"
  notify: service nginx reload
  changed_when: true

- file:
    src: "/etc/nginx/sites-available/{{ domain }}"
    dest: "/etc/nginx/sites-enabled/{{ domain }}"
    state: link
  notify: service nginx reload
  changed_when: true

- name: migrate
  command: "{{ venv_dir }}/bin/python manage.py migrate --noinput"
  args:
    chdir: "{{ cwd }}"
  environment:
    DOTENV: "{{ env_dir }}/{{ env_file }}"

- name: collectstatic
  command: "{{ venv_dir }}/bin/python manage.py collectstatic --noinput" 
  args:
    chdir: "{{ cwd }}"
  environment:
    DOTENV: "{{ env_dir }}/{{ env_file }}"

- name: collectstatic
  command: "{{ venv_dir }}/bin/python manage.py collectstatic --noinput"
  args:
    chdir: "{{ cwd }}"
  environment:
    DOTENV: "{{ env_dir }}/{{ env_file }}"
    
- name: link static dir
  file:
    src: "{{ static_root }}"
    dest: "{{ www_root }}"
    state: link
